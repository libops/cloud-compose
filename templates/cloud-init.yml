#cloud-config

users:
- name: cloud-compose
  shell: /bin/bash

bootcmd:
- fsck.ext4 -tvy $(readlink -f /dev/disk/by-id/google-data) || mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard $(readlink -f /dev/disk/by-id/google-data)
- mkdir -p /mnt/disks/data
- mount -o discard,defaults $(readlink -f /dev/disk/by-id/google-data) /mnt/disks/data
- chmod a+w /mnt/disks/data
%{ if USE_OVERLAY ~}
- mkdir -p /mnt/disks/prod-readonly
- mount -o ro $(readlink -f /dev/disk/by-id/google-prod-data) /mnt/disks/prod-readonly
%{ for path in OVERLAY_PATHS ~}
- mkdir -p /mnt/disks/data/${path}
- mkdir -p /mnt/disks/data/.overlay/${path}/upper
- mkdir -p /mnt/disks/data/.overlay/${path}/work
- mount -t overlay overlay -o lowerdir=/mnt/disks/prod-readonly/${path},upperdir=/mnt/disks/data/.overlay/${path}/upper,workdir=/mnt/disks/data/.overlay/${path}/work /mnt/disks/data/${path}
%{ endfor ~}
%{ endif ~}

write_files:
${WRITE_FILES_CONTENT}
${DOCKER_COMPOSE_SCRIPTS}
${ENV_FILE_CONTENT}

runcmd:
- bash -lx /home/cloud-compose/run.sh > /home/cloud-compose/run.log 2>&1
